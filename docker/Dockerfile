# Базовый образ с предустановленными PHP + Composer.
# Удобен для CI: сразу есть composer, предсказуемая среда, небольшой размер.
FROM composer:2

# Устанавливаем Xdebug (обычно нужен для покрытия кода в PHPUnit).
#
# Важно:
# - composer:2 основан на Alpine Linux, поэтому используем пакетный менеджер `apk`.
# - Xdebug ставится через PECL и компилируется, поэтому нужны инструменты сборки.
# - Зависимости для сборки ставим как "виртуальный пакет" .build-deps,
#   чтобы потом удалить их одной командой и не раздувать итоговый образ.
# - `set -eux`:
#   -e  прервать RUN при любой ошибке
#   -u  ошибка при обращении к неинициализированным переменным
#   -x  печатать выполняемые команды (удобно смотреть логи в CI)
RUN set -eux; \
    \
    # Ставим зависимости, нужные для сборки PECL-расширений.
    # $PHPIZE_DEPS приходит из базового образа и включает типичный набор для сборки (autoconf, gcc, make и т.п.).
    # linux-headers иногда требуются на Alpine при сборке расширений.
    apk add --no-cache --virtual .build-deps $PHPIZE_DEPS linux-headers; \
    \
    # Скачиваем, собираем и устанавливаем Xdebug через PECL.
    pecl install xdebug; \
    \
    # Включаем расширение: создаётся ini-файл в /usr/local/etc/php/conf.d/,
    # после чего Xdebug доступен в PHP (в первую очередь в CLI).
    docker-php-ext-enable xdebug; \
    \
    # Удаляем сборочные зависимости — они больше не нужны в рантайме.
    apk del .build-deps; \
    \
    # Чистим временные файлы PECL/сборки, чтобы уменьшить размер образа.
    rm -rf /tmp/pear